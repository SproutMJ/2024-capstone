<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Recommendation</title>
</head>
<body>
<h2>Recipe Recommendation</h2>

<div id="initialContainer">
  <input type="file" id="imageInput" accept="image/*">
  <button onclick="uploadAndProcessImage()">Upload and Process Image</button>
</div>

<div id="ingredientsContainer" style="display: none;">
  <div id="ingredientInputs">
    <!-- Ingredient inputs will be dynamically added here -->
  </div>
  <button onclick="addIngredientInput()">Add Ingredient</button>
  <button onclick="searchRecipes()">Search Recipes</button>
</div>

<div id="recipeResult"></div>

<script>
  function addIngredientInput() {
    const ingredientsContainer = document.getElementById('ingredientsContainer');

    // 새로운 입력창 추가
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'ingredientInput';
    input.placeholder = 'Enter ingredient';
    ingredientsContainer.querySelector('#ingredientInputs').appendChild(input);
  }

  function uploadAndProcessImage() {
    const fileInput = document.getElementById('imageInput');
    const file = fileInput.files[0];

    if (!file) {
      alert('Please select an image file.');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // 이미지 업로드 및 처리 요청
    fetch('/api/photo-recognition', {
      method: 'POST',
      body: formData
    })
            .then(response => response.text())
            .then(result => {
              showIngredients(result); // 처리 결과를 재료 입력창에 표시
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error occurred while processing image.');
            });
  }

  function showIngredients(result) {
    const ingredients = result.split(',').map(ingredient => ingredient.trim());
    const ingredientInputs = document.getElementById('ingredientInputs');

    // 기존의 재료 입력창 초기화
    ingredientInputs.innerHTML = '';

    // 이미지 처리 결과를 입력창에 자동으로 채움
    ingredients.forEach((ingredient, index) => {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'ingredientInput';
      input.placeholder = `Ingredient ${index + 1}`;
      input.value = ingredient; // 이미지 처리 결과를 입력창에 자동 입력
      ingredientInputs.appendChild(input);
    });

    // 재료 입력 컨테이너를 보이도록 설정
    document.getElementById('initialContainer').style.display = 'none';
    document.getElementById('ingredientsContainer').style.display = 'block';
  }

  function searchRecipes() {
    const ingredientInputs = document.querySelectorAll('.ingredientInput');
    const ingredients = Array.from(ingredientInputs).map(input => input.value);
    // 사용자에게 보이게 할 질문
    const displayPrompt = ingredients.join(', ') + ' 로 만들 수 있는 음식 레시피 추천해줘';

    // 재료들을 서버로 전송하여 /api/recommendation-gpt 엔드포인트에 요청 보내기
    fetch('/api/recommendation-gpt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ingredients)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to get recommendation');
              }
              return response.json();
            })
            .then(result => {
              displayRecipeResult(result, displayPrompt);
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error occurred while searching recipes.');
            });

    // 재료 입력창 숨기기
    document.getElementById('ingredientsContainer').style.display = 'none';
  }

  function displayRecipeResult(result, displayPrompt) {
    const recipeResultDiv = document.getElementById('recipeResult');
    recipeResultDiv.innerHTML = '<h3>Recommended Recipes</h3>';
    recipeResultDiv.innerHTML += `<p><strong>${displayPrompt}</strong></p>`;
    if (result && result.choices && result.choices.length > 0) {
      const recipeText = result.choices[0].text; // 첫 번째 선택지의 텍스트 가져오기
      const formattedRecipeText = recipeText.replace(/\n/g, '<br>');
      recipeResultDiv.innerHTML += `<p>${formattedRecipeText}</p>`;
    } else {
      recipeResultDiv.innerHTML += '<p>No recipes found.</p>';
    }
  }

</script>

</body>
</html>
